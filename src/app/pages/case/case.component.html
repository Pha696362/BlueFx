<ng-container *mobxAutorun>
  <div class="page-section">
    <div class="action-bar">
      <div class="nav-content">
        <h3 class="head-title">
          {{labels?.title}}
        </h3>
        <div class="flex1"></div>
        <div class="action-list-item">
          <div class="action-item">
            <button mat-button [routerLink]="['/crime/new/draft']"
              class="enbutton primary">{{labels?.addNew}}</button>

            <button mat-button [routerLink]="['/case/transfer']"
              class="enbutton primary">ផ្ទេរឧក្រិដ្ឋកម្ម</button>
          </div>
        </div>
      </div>
    </div>
    <nav mat-tab-nav-bar>
      <a mat-tab-link *ngFor="let link of tabs" [routerLink]="link.path" routerLinkActive #rla="routerLinkActive"
        [active]="rla.isActive">{{link.label}}</a>
    </nav>

    <div class="data-filter-wrapper">
      <div class="form-wrapper" [formGroup]="form">
        <div class="ui form">
          <div class="field" *ngIf="env?.isAdmin">
            <mat-checkbox class="" formControlName="search_all">ស្វែងរកទូទាំងប្រទេស</mat-checkbox>
          </div>
          <div class="fields five">
            <div class="field">
              <label>ខេត្ត <span class="rq-sign">*</span></label>
              <input type="text" [matAutocomplete]="autoProvince" placeholder="ជ្រើសរើសខេត្ត"
                formControlName="province">
              <mat-autocomplete (optionSelected)="_onSelectedProvince($event)" #autoProvince="matAutocomplete"
                [displayWith]="displayItem">
                <mat-option *ngFor="let state of filteredStatesProvince | async" [value]="state">
                  {{state?.name }}
                </mat-option>
              </mat-autocomplete>
              <div class="error-message" *ngIf="province.hasError('validKey')">
                <div>អ្នកអាចជ្រើសរើសបាននៅក្នុងទិន្នន័យនេះតែប៉ុណ្ណោះ</div>
              </div>
              <div *ngIf="form.controls['province'].hasError('required') && form.controls['province'].touched"
                class="error-message">ចន្លោះ​នេះ​ត្រូវតែ​បំពេញ</div>
            </div>
            <div class="field">
              <label>ស្រុក</label>
              <input type="text" [matAutocomplete]="autoDistrict" placeholder="ជ្រើសរើសស្រុក"
                formControlName="district">
              <mat-autocomplete (optionSelected)="_onSelectedDistrict($event)" #autoDistrict="matAutocomplete"
                [displayWith]="displayItem">
                <mat-option *ngFor="let state of filteredStatesDistrict | async" [value]="state">
                  {{state?.name }}
                </mat-option>
              </mat-autocomplete>
              <div class="error-message" *ngIf="province.hasError('validKey')">
                <div>អ្នកអាចជ្រើសរើសបាននៅក្នុងទិន្នន័យនេះតែប៉ុណ្ណោះ</div>
              </div>
              <div *ngIf="form.controls['province'].hasError('required') && form.controls['province'].touched"
                class="error-message">ចន្លោះ​នេះ​ត្រូវតែ​បំពេញ</div>
            </div>
            <div class="field">
              <label>ឃុំ</label>
              <input type="text" [matAutocomplete]="autoCommune" placeholder="ជ្រើសរើសឃុំ" formControlName="commune">
              <mat-autocomplete #autoCommune="matAutocomplete" [displayWith]="displayItem">
                <mat-option *ngFor="let state of filteredStatesCommune | async" [value]="state">
                  {{state?.name }}
                </mat-option>
              </mat-autocomplete>
              <div class="error-message" *ngIf="province.hasError('validKey')">
                <div>អ្នកអាចជ្រើសរើសបាននៅក្នុងទិន្នន័យនេះតែប៉ុណ្ណោះ</div>
              </div>
              <div *ngIf="form.controls['province'].hasError('required') && form.controls['province'].touched"
                class="error-message">ចន្លោះ​នេះ​ត្រូវតែ​បំពេញ</div>
            </div>
            <div class="field">
              <label>ប្រភេទបទល្មើស</label>
              <input type="text" [matAutocomplete]="autoCategory" placeholder="ជ្រើសរើស ប្រភេទបទល្មើស"
                formControlName="category">
              <mat-autocomplete (optionSelected)="categorySelected($event)" #autoCategory="matAutocomplete"
                [displayWith]="displayName">
                <mat-option *ngFor="let data of filteredCategoriesStates | async" [value]="data">
                  <div class="flex-box">
                    <span class="start-flex">{{data?.name}}</span>
                  </div>
                </mat-option>
              </mat-autocomplete>
              <div class="error-message" *ngIf="category.hasError('validKey')">
                <div>You can only select category from list.</div>
              </div>
              <!-- <div *ngIf="!form.get('category').valid && form.get('category').touched && !category.hasError('validKey')"
                class="error-message">
                This field is required.
              </div> -->
            </div>
            <div class="field">
              <label>បទល្មើស</label>
              <input type="text" [matAutocomplete]="autoSubCategory" placeholder="ជ្រើសរើស បទល្មើស"
                formControlName="sub_category">
              <mat-autocomplete #autoSubCategory="matAutocomplete" [displayWith]="displayName">
                <mat-option *ngFor="let data of filteredSubCategoriesStates | async" [value]="data">
                  <div class="flex-box">
                    <span class="start-flex">{{data?.name}}</span>
                  </div>
                </mat-option>
              </mat-autocomplete>
              <div class="error-message" *ngIf="sub_category.hasError('validKey')">
                <div>You can only select province from list.</div>
              </div>
              <!-- <div
                *ngIf="!form.get('sub_category').valid && form.get('sub_category').touched && !sub_category.hasError('validKey')"
                class="error-message">
                This field is required.
              </div> -->
            </div>
          </div>

          <div class="five fields">
            <div class="field">
              <label>ចន្លោះពេល</label>
              <div class="mixfeild">
                <input type="text" date="true" (click)="dobpicker1.open()" formControlName="from_date"
                  [matDatepicker]="dobpicker1" placeholder="ការបរិច្ឆេទទទួលព័ត៌មានចាប់ពី">
                <mat-datepicker-toggle matSuffix [for]="dobpicker1"></mat-datepicker-toggle>
                <mat-datepicker #dobpicker1></mat-datepicker>
              </div>
            </div>
            <div class="field">
              <label>ដល់</label>
              <div class="mixfeild">
                <input type="text" date="true" (click)="dobpicker2.open()" formControlName="to_date"
                  [matDatepicker]="dobpicker2" placeholder="រហូតដល់ថ្ងៃទី">
                <mat-datepicker-toggle matSuffix [for]="dobpicker2"></mat-datepicker-toggle>
                <mat-datepicker #dobpicker2></mat-datepicker>
              </div>
            </div>
            <!-- <div class="field">
            </div>
            <div class="field">
            </div> -->
            <div class="field">
              <label>
                <div style="visibility: hidden;">search</div>
              </label>
              <button mat-button (click)="_onSearch(form.value)" class="data-filter-btn" style="width: 100%">
                <mat-icon class="mat-18">search</mat-icon>
                បង្ហាញទិន្នន័យ
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <ng-container *ngIf="store?.data?.length>0 && !store?.loading">
      <div class="card-wrapper tab">
        <div class="tb-content">
          <div class="card-header">
            <div class="card-item">
              <div class="card-col5">
                <div class="flex-block">
                  លេខរៀង
                </div>
              </div>
              <div class="card-col10">
                <div class="flex-block">
                  លេខករណី
                </div>
              </div>
              <div class="card-col15">
                <div class="flex-block">
                  ថ្ងៃខែឆ្នាំកើតហេតុ
                </div>
              </div>
              <div class="card-col15">
                <div class="flex-block">
                  ទីកន្លែងកើតហេតុ
                </div>
              </div>
              <div class="card-col15">
                <div class="flex-block">
                  ប្រភេទបទល្មើស
                </div>
              </div>
              <div class="card-col10">
                <div class="flex-block">
                  អ្នករងគ្រោះ
                </div>
              </div>
              <div class="card-col15">
                <div class="flex-block">
                  ជនសង្ស័យ
                </div>
              </div>
              <div class="card-col10">
                <div class="flex-block">
                  ស្ថានភាព
                </div>
              </div>
              <div class="card-col5"></div>
            </div>
          </div>
          <div class="card-content">
            <ng-container *ngFor="let item of store?.data ;let i=index">
              <div class="card-item">
                <div class="card-col5">
                  <div class="flex-block">
                    <span>{{i+1}}</span>
                  </div>
                </div>
                <div class="card-col10">
                  <div class="flex-block link">
                    <strong [routerLink]="['/crime-profile/' + item?.key + '/overview']">{{item?.crime_no}}</strong>
                  </div>
                </div>
                <div class="card-col15">
                  <div class="flex-block">
                    <!-- {{item?.create_date?.toDate() | date:'short'}} -->
                    {{item?.case_happen_date?.toDate() | date:'short'}}
                    <span *ngIf="item?.case_happen_time">ម៉ោង {{item?.case_happen_time}}</span>
                  </div>
                </div>
                <div class="card-col15">
                  <div class="flex-block">
                    ឃុំ {{item?.commune?.name}} ភូមិ {{item?.village?.name}}
                  </div>
                </div>
                <div class="card-col15">
                  <div class="flex-block">
                    {{item?.category?.name}} \ {{item?.sub_category?.name}}
                  </div>
                </div>
                <div class="card-col10">
                  <div class="flex-block">
                    {{item?.victim_total}} នាក់
                  </div>
                </div>
                <div class="card-col15">
                  <div class="flex-block">
                    ឃាត់ខ្លួន {{item?.suspect_arrested_total}} នាក់ / {{item?.suspect_total}} នាក់
                  </div>
                </div>
                <div class="card-col10">
                  <div class="flex-block">
                    <span class="status"
                      [ngClass]="item?.crime_status?.key ==2 ?'green': ''">{{item?.crime_status?.text}} 
                      <span *ngIf="item?.resolved_date">{{item?.resolved_date?.toDate() | date:'short'}}</span>
                    </span>
                  </div>
                </div>
                <div class="card-col5">
                  <div class="card-list-action" *ngIf="env?.isReadWrite && item?.crime_status?.key<3">
                    <button mat-icon-button [matMenuTriggerFor]="menu">
                      <i class="material-icons">more_vert</i>
                    </button>
                    <mat-menu #menu="matMenu">
                      <!-- <button mat-menu-item (click)="confirmDone(item)">
                        <mat-icon>done_all</mat-icon>
                        <span>Complete</span>
                      </button> -->
                      <button mat-menu-item [routerLink]="['/new-case/hold/' + item?.key]">
                        <mat-icon>edit</mat-icon>
                        <span>Edit</span>
                      </button>
                      <button mat-menu-item (click)="delete(item)">
                        <mat-icon>delete</mat-icon>
                        <span>Delete</span>
                      </button>
                    </mat-menu>
                  </div>
                  <div class="card-list-action" *ngIf="env?.isAdmin">
                    <button mat-icon-button [matMenuTriggerFor]="menu">
                      <i class="material-icons">more_vert</i>
                    </button>
                    <mat-menu #menu="matMenu">
                      <button mat-menu-item [routerLink]="['/new-case/hold/' + item?.key]">
                        <mat-icon>edit</mat-icon>
                        <span>Edit</span>
                      </button>
                      <button mat-menu-item (click)="_transfer(item)">
                        <mat-icon>transform</mat-icon>
                        <span>ផ្ទេរឧក្រិដ្ឋកម្ម</span>
                      </button>
                      <!-- <button mat-menu-item (click)="resolve(item)">
                        <mat-icon>delete</mat-icon>
                        <span>Resolve</span>
                      </!-->
                    </mat-menu>
                  </div>
                </div>
              </div>
            </ng-container>
          </div>
        </div>
      </div>
    </ng-container>

    <ng-container *ngIf="!store?.data?.length>0 && !store?.loading">
      <div class="empty-block">
        <div class="center-block-empty">
          <div class="empty-img">
            <img src="https://mobilecenter.azureedge.net/generated/img/no-apps-db6363dd644196e2291b243bc210e1b0.svg"
              alt="empty">
          </div>
          <div class="empty-text">
            <p class="empty-state-title">
              {{labels?.empty}}
            </p>
            <p class="empty-state-desc">
              {{labels?.emptyNote}}
            </p>
            <button mat-button *ngIf="env?.isReadWrite" class="add-button"
              [routerLink]="['/new-case']">{{labels?.addNew}}</button>
          </div>
        </div>
      </div>
    </ng-container>
  </div>
  <app-spinner *ngIf="store?.loading"></app-spinner>
</ng-container>